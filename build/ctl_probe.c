/* Autogenerated by zcc. Do not edit. */
#include <stdint.h>
#include <stddef.h>
#include <string.h>
#include "zprog_rt.h"

#define ZPROG_MEM_CAP 65640
#define ZPROG_RET_STACK_CAP 256
enum {
  ZPROG_TRAP_OOB = 1,
  ZPROG_TRAP_CALL_DEPTH = 2,
  ZPROG_TRAP_HOST_MISSING = 3,
  ZPROG_TRAP_HOST_FAIL = 4,
  ZPROG_TRAP_ALLOC = 5
};

static inline int zprog_bounds(int32_t addr, int32_t len) {
  if (addr < 0 || len < 0) return 0;
  size_t end = (size_t)addr + (size_t)len;
  return end <= ZPROG_MEM_CAP;
}

enum { ZPROG_HEAP_BASE = 104 };

static const uint32_t ZPROG_HEAP_BASE_CONST = ZPROG_HEAP_BASE;
uint32_t zprog_heap_base_value(void) { return ZPROG_HEAP_BASE_CONST; }

struct zprog_state {
  int32_t HL;
  int32_t DE;
  int32_t A;
  int32_t BC;
  int32_t IX;
  int32_t cmp;
  uint8_t mem[ZPROG_MEM_CAP];
};

static const uint8_t zprog_seg_0[] = {
  0x5a, 0x43, 0x4c, 0x31, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint8_t zprog_seg_1[] = {
  0x43, 0x61, 0x70, 0x73, 0x20, 0x6c, 0x69, 0x73, 0x74, 0x20, 0x6f, 0x6b, 0x0a
};

static void zprog_state_init(struct zprog_state* state) {
  memset(state, 0, sizeof(*state));
  memcpy(state->mem + 0, zprog_seg_0, 24);
  memcpy(state->mem + 88, zprog_seg_1, 13);
}

enum {
  ZSYM_req_caps = 0,
  ZSYM_req_caps_len = 24,
  ZSYM_resp_buf = 24,
  ZSYM_resp_buf_len = 64,
  ZSYM_msg_caps = 88,
  ZSYM_msg_caps_len = 13,
};

int lembeh_handle(int32_t req_handle,
                  int32_t res_handle,
                  zprog_in_fn in_fn,
                  zprog_out_fn out_fn,
                  zprog_end_fn end_fn,
                  zprog_log_fn log_fn,
                  zprog_ctl_fn ctl_fn,
                  void* host_ctx,
                  const struct zprog_sys* sys) {
  (void)out_fn; /* may be unused */
  (void)end_fn;
  (void)log_fn;
  (void)ctl_fn;
  struct zprog_state state;
  zprog_state_init(&state);
  int32_t pc = 0;
  int32_t ret_stack[ZPROG_RET_STACK_CAP];
  int32_t sp = 0;
  for (;;) {
    switch (pc) {
    case 0: { /* line -1 LD */
      state.HL = 0;
      pc = 1;
      break;
    }
    case 1: { /* line -1 LD */
      state.DE = 24;
      pc = 2;
      break;
    }
    case 2: { /* line -1 LD */
      state.BC = 24;
      pc = 3;
      break;
    }
    case 3: { /* line -1 LD */
      state.IX = 64;
      pc = 4;
      break;
    }
    case 4: { /* line -1 LD */
      state.A = 0;
      pc = 5;
      break;
    }
    case 5: { /* line -1 CALL */
      if (!ctl_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (!zprog_bounds(state.BC, state.IX)) return ZPROG_TRAP_OOB;
      int32_t ctl_written = ctl_fn(host_ctx, ZCAP_CTL, state.mem, ZPROG_MEM_CAP, state.HL, state.DE, state.BC, state.IX, state.A);
      if (ctl_written < 0) return ZPROG_TRAP_HOST_FAIL;
      state.HL = ctl_written;
      pc = 6;
      break;
    }
    case 6: { /* line -1 LD */
      state.HL = 88;
      pc = 7;
      break;
    }
    case 7: { /* line -1 LD */
      state.DE = 13;
      pc = 8;
      break;
    }
    case 8: { /* line -1 CALL */
      if (!out_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (out_fn(host_ctx, res_handle, state.mem, ZPROG_MEM_CAP, state.HL, state.DE) < 0) return ZPROG_TRAP_HOST_FAIL;
      pc = 9;
      break;
    }
    case 9: { /* line -1 RET */
      if (sp == 0) return 0;
      pc = ret_stack[--sp];
      break;
    }
      default: return 0;
    }
  }
}
