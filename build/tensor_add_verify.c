/* Autogenerated by zcc. Do not edit. */
#include <stdint.h>
#include <stddef.h>
#include <string.h>
#include "zprog_rt.h"

#define ZPROG_MEM_CAP 65888
#define ZPROG_RET_STACK_CAP 256
enum {
  ZPROG_TRAP_OOB = 1,
  ZPROG_TRAP_CALL_DEPTH = 2,
  ZPROG_TRAP_HOST_MISSING = 3,
  ZPROG_TRAP_HOST_FAIL = 4,
  ZPROG_TRAP_ALLOC = 5
};

static inline int zprog_bounds(int32_t addr, int32_t len) {
  if (addr < 0 || len < 0) return 0;
  size_t end = (size_t)addr + (size_t)len;
  return end <= ZPROG_MEM_CAP;
}

enum { ZPROG_HEAP_BASE = 352 };

static const uint32_t ZPROG_HEAP_BASE_CONST = ZPROG_HEAP_BASE;
uint32_t zprog_heap_base_value(void) { return ZPROG_HEAP_BASE_CONST; }

struct zprog_state {
  int32_t HL;
  int32_t DE;
  int32_t A;
  int32_t BC;
  int32_t IX;
  int32_t cmp;
  uint8_t mem[ZPROG_MEM_CAP];
};

static const uint8_t zprog_seg_0[] = {
  0x5a, 0x43, 0x54, 0x4c, 0x01, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint8_t zprog_seg_1[] = {
  0x3d, 0x3d, 0x3d, 0x20, 0x54, 0x65, 0x6e, 0x73, 0x6f, 0x72, 0x20, 0x41, 0x64, 0x64, 0x20, 0x56, 
  0x65, 0x72, 0x69, 0x66, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x28, 0x76, 0x69, 0x61, 
  0x20, 0x4a, 0x53, 0x4f, 0x4e, 0x4c, 0x29, 0x20, 0x3d, 0x3d, 0x3d, 0x0a
};

static const uint8_t zprog_seg_2[] = {
  0x4c, 0x61, 0x75, 0x6e, 0x63, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x74, 0x65, 0x6e, 0x73, 0x6f, 0x72, 
  0x5f, 0x61, 0x64, 0x64, 0x20, 0x6b, 0x65, 0x72, 0x6e, 0x65, 0x6c, 0x20, 0x28, 0x38, 0x20, 0x65, 
  0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x73, 0x29, 0x2e, 0x2e, 0x2e, 0x0a
};

static const uint8_t zprog_seg_3[] = {
  0x4b, 0x65, 0x72, 0x6e, 0x65, 0x6c, 0x20, 0x73, 0x74, 0x61, 0x74, 0x75, 0x73, 0x3a, 0x20
};

static const uint8_t zprog_seg_4[] = {
  0x53, 0x55, 0x43, 0x43, 0x45, 0x53, 0x53, 0x0a
};

static const uint8_t zprog_seg_5[] = {
  0x0a, 0x47, 0x50, 0x55, 0x20, 0x63, 0x6f, 0x6d, 0x70, 0x75, 0x74, 0x61, 0x74, 0x69, 0x6f, 0x6e, 
  0x20, 0x76, 0x65, 0x72, 0x69, 0x66, 0x69, 0x65, 0x64, 0x20, 0x76, 0x69, 0x61, 0x20, 0x5a, 0x43, 
  0x54, 0x4c, 0x2f, 0x31, 0x20, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x63, 0x6f, 0x6c, 0x21, 0x0a
};

static void zprog_state_init(struct zprog_state* state) {
  memset(state, 0, sizeof(*state));
  memcpy(state->mem + 0, zprog_seg_0, 96);
  memcpy(state->mem + 192, zprog_seg_1, 44);
  memcpy(state->mem + 236, zprog_seg_2, 44);
  memcpy(state->mem + 280, zprog_seg_3, 15);
  memcpy(state->mem + 296, zprog_seg_4, 8);
  memcpy(state->mem + 304, zprog_seg_5, 47);
}

enum {
  ZSYM_req_kernel_run = 0,
  ZSYM_req_len = 112,
  ZSYM_resp_buf = 96,
  ZSYM_resp_buf_len = 96,
  ZSYM_msg_header = 192,
  ZSYM_msg_header_len = 44,
  ZSYM_msg_launching = 236,
  ZSYM_msg_launching_len = 44,
  ZSYM_msg_status = 280,
  ZSYM_msg_status_len = 15,
  ZSYM_msg_success = 296,
  ZSYM_msg_success_len = 8,
  ZSYM_msg_done = 304,
  ZSYM_msg_done_len = 47,
};

int lembeh_handle(int32_t req_handle,
                  int32_t res_handle,
                  zprog_in_fn in_fn,
                  zprog_out_fn out_fn,
                  zprog_end_fn end_fn,
                  zprog_log_fn log_fn,
                  zprog_ctl_fn ctl_fn,
                  void* host_ctx,
                  const struct zprog_sys* sys) {
  (void)out_fn; /* may be unused */
  (void)end_fn;
  (void)log_fn;
  (void)ctl_fn;
  struct zprog_state state;
  zprog_state_init(&state);
  int32_t pc = 0;
  int32_t ret_stack[ZPROG_RET_STACK_CAP];
  int32_t sp = 0;
  for (;;) {
    switch (pc) {
    case 0: { /* line -1 LD */
      state.HL = 192;
      pc = 1;
      break;
    }
    case 1: { /* line -1 LD */
      state.DE = 44;
      pc = 2;
      break;
    }
    case 2: { /* line -1 CALL */
      if (!out_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (out_fn(host_ctx, res_handle, state.mem, ZPROG_MEM_CAP, state.HL, state.DE) < 0) return ZPROG_TRAP_HOST_FAIL;
      pc = 3;
      break;
    }
    case 3: { /* line -1 LD */
      state.HL = 236;
      pc = 4;
      break;
    }
    case 4: { /* line -1 LD */
      state.DE = 46;
      pc = 5;
      break;
    }
    case 5: { /* line -1 CALL */
      if (!out_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (out_fn(host_ctx, res_handle, state.mem, ZPROG_MEM_CAP, state.HL, state.DE) < 0) return ZPROG_TRAP_HOST_FAIL;
      pc = 6;
      break;
    }
    case 6: { /* line -1 LD */
      state.HL = 0;
      pc = 7;
      break;
    }
    case 7: { /* line -1 LD */
      state.DE = 112;
      pc = 8;
      break;
    }
    case 8: { /* line -1 LD */
      state.BC = 96;
      pc = 9;
      break;
    }
    case 9: { /* line -1 LD */
      state.IX = 96;
      pc = 10;
      break;
    }
    case 10: { /* line -1 LD */
      state.A = 0;
      pc = 11;
      break;
    }
    case 11: { /* line -1 CALL */
      if (!ctl_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (!zprog_bounds(state.BC, state.IX)) return ZPROG_TRAP_OOB;
      int32_t ctl_written = ctl_fn(host_ctx, ZCAP_CTL, state.mem, ZPROG_MEM_CAP, state.HL, state.DE, state.BC, state.IX, state.A);
      if (ctl_written < 0) return ZPROG_TRAP_HOST_FAIL;
      state.HL = ctl_written;
      pc = 12;
      break;
    }
    case 12: { /* line -1 LD */
      state.HL = 280;
      pc = 13;
      break;
    }
    case 13: { /* line -1 LD */
      state.DE = 15;
      pc = 14;
      break;
    }
    case 14: { /* line -1 CALL */
      if (!out_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (out_fn(host_ctx, res_handle, state.mem, ZPROG_MEM_CAP, state.HL, state.DE) < 0) return ZPROG_TRAP_HOST_FAIL;
      pc = 15;
      break;
    }
    case 15: { /* line -1 LD */
      state.HL = 296;
      pc = 16;
      break;
    }
    case 16: { /* line -1 LD */
      state.DE = 8;
      pc = 17;
      break;
    }
    case 17: { /* line -1 CALL */
      if (!out_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (out_fn(host_ctx, res_handle, state.mem, ZPROG_MEM_CAP, state.HL, state.DE) < 0) return ZPROG_TRAP_HOST_FAIL;
      pc = 18;
      break;
    }
    case 18: { /* line -1 LD */
      state.HL = 304;
      pc = 19;
      break;
    }
    case 19: { /* line -1 LD */
      state.DE = 46;
      pc = 20;
      break;
    }
    case 20: { /* line -1 CALL */
      if (!out_fn) return ZPROG_TRAP_HOST_MISSING;
      if (!zprog_bounds(state.HL, state.DE)) return ZPROG_TRAP_OOB;
      if (out_fn(host_ctx, res_handle, state.mem, ZPROG_MEM_CAP, state.HL, state.DE) < 0) return ZPROG_TRAP_HOST_FAIL;
      pc = 21;
      break;
    }
    case 21: { /* line -1 RET */
      if (sp == 0) return 0;
      pc = ret_stack[--sp];
      break;
    }
      default: return 0;
    }
  }
}
